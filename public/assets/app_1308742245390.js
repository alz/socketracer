(function(){var Car,Point,after,bindEvents,broadcastCarData,cssTransform,displaySignInForm,drawCanvas,drawTiles,drawTilesOld,every,initCar,initCars,initMyCar,loadImages,loadSession,redraw,rotateStyles,runGame,signUserIn,touchEvent,transformOrigin,translateStyles,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};SS.client.app||(SS.client.app={}),window.sr={user:null,infocus:!0,canvas:!1,cars:{},mycar:null,lkd:0,lku:0,kpt:null,running:!1,debugmode:!1,eps:1e-6,chatmode:!1,msgmax:1e5,mrecv:0},SS.client.app.init=function(){return SS.client.browser.isSupported()?loadSession():SS.client.browser.showIncompatibleMessage()},loadSession=function(){return SS.server.app.init(function(user){return displaySignInForm()})},touchEvent=function(e,type,val){sr.mycar.set(type,val),e.preventDefault();return broadcastCarData(sr.mycar)},bindEvents=function(){$("#changecol").click(function(e){var col;col=sr.mycar.getColour()+1,col>7&&(col=0),sr.mycar.setColour(col),e.preventDefault();return!1}),$("#debug").click(function(e){sr.debugmode=!sr.debugmode,sr.debugmode?$("#cardebug").show():$("#cardebug").hide(),e.preventDefault();return!1}),document.onorientationchange=function(e){window.scrollTo(0,1);return e.preventDefault()};if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i))window.ondevicemotion=function(e){var arate;sr.mycar.set("st_speed",e.accelerationIncludingGravity.x),arate=e.accelerationIncludingGravity.y,arate>0?(sr.mycar.set("decel",!1),sr.mycar.set("accel",!0)):arate<0&&(sr.mycar.set("accel",!1),sr.mycar.set("decel",!0)),sr.mycar.set("accel_rate",arate);return e.preventDefault()};document.getElementById("control-left").ontouchstart=function(e){return touchEvent(e,"tl",!0)},document.getElementById("control-left").ontouchend=function(e){return touchEvent(e,"tl",!1)},document.getElementById("control-right").ontouchstart=function(e){return touchEvent(e,"tr",!0)},document.getElementById("control-right").ontouchend=function(e){return touchEvent(e,"tr",!1)},document.getElementById("control-up").ontouchstart=function(e){return touchEvent(e,"accel",!0)},document.getElementById("control-up").ontouchend=function(e){return touchEvent(e,"accel",!1)},document.getElementById("control-down").ontouchstart=function(e){return touchEvent(e,"decel",!0)},document.getElementById("control-down").ontouchend=function(e){return touchEvent(e,"decel",!1)},$(document).keydown(function(e){var msg,opt,send;opt="";if(sr.chatmode===!0&&e.keyCode!==13)return!0;if(e.keyCode===13){sr.chatmode===!0?($("#chatentry").hide(),msg=$("#chatentry").val(),msg.length>0&&(send={name:sr.mycar.name,msg:$("#chatentry").val()},$("#chatentry").val(""),SS.server.app.chatMsg(send,!0)),sr.chatmode=!1):($("#chatentry").show().focus(),sr.chatmode=!0,sr.mycar.set("accel",!1),sr.mycar.set("decel",!1),sr.mycar.set("tr",!1),sr.mycar.set("tl",!1),sr.mycar.set("hbrake",!1)),e.preventDefault();return!0}if(e.keyCode===38)opt="accel";else if(e.keyCode===40)opt="decel";else if(e.keyCode===37)opt="tl";else if(e.keyCode===39)opt="tr";else if(e.keyCode===32)opt="hbrake";else return!0;opt.length>0&&(sr.mycar.enable(opt),e.preventDefault()),sr.mycar!==!1&&sr.lkd!==e.keyCode&&sr.kpt===!1&&broadcastCarData(sr.mycar),sr.lkd=e.keyCode,sr.kpt=!0;return!1});return $(document).keyup(function(e){var opt;if(sr.chatmode===!0)return!0;opt="";if(e.keyCode===38)opt="accel";else if(e.keyCode===40)opt="decel";else if(e.keyCode===37)opt="tl";else if(e.keyCode===39)opt="tr";else if(e.keyCode===32)opt="hbrake";else return!1;opt.length>0&&(sr.mycar.disable(opt),e.preventDefault()),sr.mycar!==!1&&sr.lku!==e.keyCode&&sr.kpt===!0&&broadcastCarData(sr.mycar),sr.lku=e.keyCode,sr.kpt=!1;return!1})},signUserIn=function(data){sr.infocus=!0,$("#main").show(),loadImages(),drawCanvas(),bindEvents();return runGame()},initCars=function(cars){var car,newcar,_i,_len,_results;console.log(cars);return},initCar=function(car,local){var car_elem,elem,ielem,img_elem,newcar,pcl,pct,rad,radcar,t,tc,_i,_len,_ref;t=$("#"+car.id);if(t){_ref=sr.cars;for(_i=0,_len=_ref.length;_i<_len;_i++){tc=_ref[_i];if(tc.id=car.id)return tc}}if(sr.mycar&&sr.mycar.id===car.id)return sr.mycar;elem=document.createElement("div"),ielem=document.createElement("div"),car_elem=$(elem).addClass("car"),img_elem=$(ielem).addClass("img"),car_elem.attr({id:car.id}),img_elem.html("<p>"+car.name.substring(0,4).toLowerCase()+"</p>"),car_elem.append(img_elem),rad=document.createElement("div"),radcar=$(rad).addClass("car"),radcar.attr({id:"_rad-"+car.id}),car.name===sr.user&&radcar.addClass("me"),pcl=car.xpos/sr.viewportw*100,pct=car.ypos/sr.viewporth*100,radcar.css({left:pcl+"%",top:pct+"%"}),$("#radar").append(radcar),sr.viewport.append(car_elem),newcar=new Car(car.colour,car.name,local,car_elem,img_elem),$.each(car,function(k,v){return newcar[k]=v});return newcar},initMyCar=function(car){return sr.mycar=initCar(car,!0)},loadImages=function(){var img,tiles;sr.viewportw=5120,sr.viewporth=5120,sr.viewportx=0,sr.viewporty=0,tiles=new Image,tiles.src="/images/asphaltsprite.png",sr.tilesprite=$(tiles),img=new Image,img.src="/images/minis.png",sr.carsprite=$(img);return sr.cars={}},runGame=function(){sr.running=!0,every(33,function(){return redraw()});return every(150,function(){return broadcastCarData(sr.mycar)})},drawCanvas=function(){var canvas,img;sr.canvas=$("#canvas"),canvas=sr.canvas,sr.viewport=canvas.find("#viewport"),sr.tiles=canvas.find("#tiles"),canvas.width(window.innerWidth),canvas.height(window.innerHeight-96),canvas.css({width:canvas.width(),height:canvas.height()}),img=new Image,img.src="/images/minis.png",img.onload=function(){return console.log("loaded sprite")},sr.carimg=img,drawTiles(canvas),sr.debugmode&&$("#cardebug").show();if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i))$("#buttons-left").find("div").show(),$("#buttons-right").find("div").show(),window.scrollTo(0,1);return!0},redraw=function(){var canvas,cheight,cwidth,cx,cy,nx,ny,pos;canvas=sr.canvas,cx=sr.mycar.xpos,cy=sr.mycar.ypos,pos=canvas.position(),cwidth=sr.canvas.width(),cheight=sr.canvas.height(),nx=0,ny=0,cx>cwidth/2&&(nx=Math.round(cx-cwidth/2),nx+cwidth>sr.viewportw&&(nx=Math.round(sr.viewportw-cwidth))),cy>cheight/2&&(ny=Math.round(cy-cheight/2),ny+cheight>sr.viewporth&&(ny=Math.round(sr.viewporth-cheight))),(nx!==sr.viewportx||ny!==sr.viewporty)&&sr.viewport.css({left:-nx,top:-ny}),sr.viewportx=nx,sr.viewporty=ny,$.each(sr.cars,function(k,v){return sr.cars[k].draw()}),sr.mycar.draw();if(sr.debugmode)return sr.mycar.updateDebug()},drawTiles=function(){var el,newdiv,offset,px,py,row,rx,th,tile,tw,_i,_j,_len,_len2,_ref,_results;tw=SS.config.map.tile_width,th=SS.config.map.tile_height,py=0,_ref=SS.config.map.tiles,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){row=_ref[_i],px=0;for(_j=0,_len2=row.length;_j<_len2;_j++)tile=row[_j],rx=1,el=document.createElement("span"),offset="0px -"+tile*th+"px",newdiv=$(el).css({left:px,top:py,"background-position":offset,"background-image":"url("+SS.config.map.sprite+")"}).addClass("tile"),rx===10&&newdiv.addClass("tileend"),rx++,sr.tiles.append(newdiv),px+=tw;_results.push(py+=th)}return _results},drawTilesOld=function(){var col,col1,col2,el,fcol,newdiv,nx,ny,px,py,rx,ry,th,tw,_results;tw=512,th=512,nx=sr.viewportw/tw,ny=sr.viewporty/th,col1="#efe",col2="#eef",col=!1,_results=[];for(ry=0;ry<=10;ry++)_results.push(function(){var _results2;_results2=[];for(rx=0;rx<=10;rx++)col?(fcol=col1,col=!1):(fcol=col2,col=!0),px=rx*tw,py=ry*th,el=document.createElement("span"),newdiv=$(el).css({left:px,top:py,"background-color":fcol}).addClass("tile"),rx===100&&newdiv.addClass("tileend"),_results2.push(sr.tiles.append(newdiv));return _results2}());return _results},displaySignInForm=function(){return $("#signIn").show().submit(__bind(function(){sr.user=$("#signIn").find('input[type="text"]').val();return SS.server.app.signIn($("#signIn").find('input[type="text"]').val(),function(response){$("#signInError").remove();if(response===!1){$("#signIn").find('input[type="text"]').val("");return $("#signIn").append("<p id='signInError'>Error signing in</p>")}$("#signIn").fadeOut(230);return signUserIn(response)})},this))},translateStyles=function(x,y){var string;string="translate("+x+"px, "+y+"px)";return cssTransform(string)},rotateStyles=function(rot){var string;string="rotate("+rot+"deg)";return cssTransform(string)},transformOrigin=function(x,y){var string;string=""+x+"% "+y+"%";return{"-webkit-transform-origin":string,"-moz-transform-origin":string,"-o-transform-origin":string,"-ms-transform-origin":string,"transform-origin":string}},cssTransform=function(string){return{"-webkit-transform":string,"-moz-transform":string,"-o-transform":string,"-ms-transform":string,transform:string}},broadcastCarData=function(car){var key,out,transmit,value;if(car===null)return!1;transmit=["id","reverse","hbrake","brakes","colour","ypos","xpos","speed","st_speed","accel","decel","angle","tr","tl","name","spritey","accel_rate","velX","velY","velAng","speedDecay","turnSpeed"],out={};for(key in car)value=car[key],transmit.include(key)&&(out[key]=value);return SS.server.app.updateCar(out)},Point=function(){Point.prototype.x=null,Point.prototype.y=null;function Point(x,y){this.x=x,this.y=y}return Point}(),Car=function(){Car.prototype.element=null,Car.prototype.imgelement=null,Car.prototype.local=!1,Car.prototype.width=70,Car.prototype.height=128,Car.prototype.reverse=!1,Car.prototype.hbrake=!1,Car.prototype.brakes=!1,Car.prototype.colour=0,Car.prototype.ypos=100,Car.prototype.xpos=100,Car.prototype.speed=0,Car.prototype.st_speed=0,Car.prototype.maxspeed=7,Car.prototype.maxstspeed=3,Car.prototype.accel=!1,Car.prototype.decel=!1,Car.prototype.accel_rate=.4,Car.prototype.s_accel_rate=.5,Car.prototype.st_drag=.6,Car.prototype.velX=0,Car.prototype.velY=0,Car.prototype.drag=.7,Car.prototype.angle=0,Car.prototype.velAng=0,Car.prototype.dragAng=.5,Car.prototype.speed=0,Car.prototype.speedDecay=.9,Car.prototype.turnSpeed=3,Car.prototype.tr=!1,Car.prototype.tl=!1,Car.prototype.name="",Car.prototype.spritey=0,Car.prototype.id=null,Car.prototype.cbox=null,Car.prototype.ctimeout=null;function Car(colour,name,local,element,img){this.setColour(colour),this.name=name,this.local=local,this.spritey=Math.round(this.colour*128.375),this.element=element,this.imgelement=img}Car.prototype.setColour=function(col){this.colour=col;return this.spritey=Math.round(this.colour*128.375)},Car.prototype.getColour=function(){return this.colour},Car.prototype.toggle=function(prop){return this[prop]=!this[prop]},Car.prototype.enable=function(prop){return this[prop]=!0},Car.prototype.disable=function(prop){return this[prop]=!1},Car.prototype.set=function(k,v){return this[k]=v},Car.prototype.getPoints=function(){var p1,p2,pos;pos=this.imgelement.position(),p1=new Point(pos.left,pos.top),p2=new Point(pos.left,pos.top);return[p1,p2]},Car.prototype.getSpriteX=function(){if(this.brakes===!0)return-70;return this.reverse===!0?-140:0},Car.prototype.getSpriteY=function(){return this.spritey},Car.prototype.moveCar=function(){!this.accel&&!this.decel&&(this.speed*=this.speedDecay),this.speed>=-0.1&&this.speed<=.1&&(this.speed=0),this.st_speed>=-0.1&&this.st_speed<=.1&&(this.st_speed=0),!this.tl&&!this.tr&&(this.st_speed*=this.st_drag),this.accel===!0&&(this.speed<0&&(this.speed+=this.accel_rate*2),this.speed<this.maxspeed&&(this.local?this.speed+=this.accel_rate:this.speed+=this.accel_rate/2)),this.decel===!0&&(this.speed>0&&(this.speed*=this.drag),this.speed>-(this.maxspeed/2)&&(this.speed-=this.accel_rate)),this.tr===!0&&this.speed!==0&&(this.st_speed<=0&&(this.st_speed=0),this.st_speed<this.maxstspeed&&(this.st_speed+=this.s_accel_rate)),this.tl===!0&&this.speed!==0&&(this.st_speed>0&&(this.st_speed=0),this.st_speed>0-this.maxstspeed&&(this.st_speed-=this.s_accel_rate)),this.hbrake===!0&&(this.speed>0&&(this.speed-=this.accel_rate*2,this.speed<0&&(this.speed=0)),this.speed<0&&(this.speed+=this.accel_rate*3,this.speed>0&&(this.speed=0))),this.decel&&this.speed>0?this.enable("brakes"):this.disable("brakes"),this.hbrake&&this.enable("brakes"),this.speed<0?this.enable("reverse"):this.disable("reverse"),this.speed>this.maxspeed&&(this.speed=this.maxspeed),this.speed=Math.round(this.speed*100)/100,this.st_speed=Math.round(this.st_speed*100)/100,this.xpos+=this.velX,this.ypos+=this.velY,this.velX*=this.drag,this.velY*=this.drag,this.xpos=Math.round(this.xpos*100)/100,this.ypos=Math.round(this.ypos*100)/100,this.angle+=this.velAng,this.velAng*=this.dragAng,this.velX>-0.1&&this.velX<.1&&(this.velX=0),this.velY>-0.1&&this.velY<.1&&(this.velY=0),this.velAng>-0.1&&this.velAng<.1&&(this.velAng=0),this.velX+=Math.cos(this.angle*Math.PI/180)*this.speed,this.velY+=Math.sin(this.angle*Math.PI/180)*this.speed,this.hbrake===!0?this.velAng+=this.st_speed*1.5*(this.speed/this.maxspeed):this.velAng+=this.st_speed*(this.speed/this.maxspeed),this.angle=Math.round(this.angle),this.angle>360&&(this.angle-=360),this.angle<0&&(this.angle+=360),this.xpos<0&&(this.xpos=0),this.ypos<0&&(this.ypos=0),this.xpos>sr.viewportw&&(this.xpos=sr.viewportw);if(this.ypos>sr.viewporth)return this.ypos=sr.viewporth},Car.prototype.updateDebug=function(){var tile,tx,ty;tx=Math.floor(this.xpos/SS.config.map.tile_width),ty=Math.floor(this.ypos/SS.config.map.tile_height),tile=SS.config.map.tiles[ty][tx];return $("#cardebug").html("Angle: "+this.angle+"<br />"+("Speed: "+this.speed+"<br />")+("Accel: "+this.accel+"<br />")+("Decel: "+this.decel+"<br />")+("St Speed: "+this.st_speed+"<br />")+("Brakes: "+this.brakes+"<br />")+("Handbrake: "+this.hbrake+"<br />")+("Reverse: "+this.reverse+"<br />")+("TL: "+this.tl+"<br />")+("TR: "+this.tr+"<br />")+("X: "+this.xpos+"<br />")+("Y: "+this.ypos+"<br />")+("XD: "+this.xd+"<br />")+("YD: "+this.yd+"<br />")+("VPX: "+sr.viewportx+"<br />")+("VPY: "+sr.viewporty+"<br />")+("TX: "+tx+"<br />")+("TY: "+ty+"<br />")+("Tile: "+tile))},Car.prototype.destroy=function(){return this.element.fadeOut(1e3,__bind(function(){this.element.remove();return delete sr.cars[this.name]},this))},Car.prototype.draw=function(ctx){var bgpos,pcl,pct,rotateobj,xpos,ypos;this.moveCar();if(this.element){bgpos=""+this.getSpriteX()+"px "+this.getSpriteY()+"px",xpos=Math.round(this.xpos-this.width/2),ypos=Math.round(this.ypos-this.height/3),this.element.css({left:this.xpos,top:this.ypos}),rotateobj=rotateStyles(this.angle+90),rotateobj["background-position"]=bgpos,this.imgelement.css(rotateobj),pcl=this.xpos/sr.viewportw*100,pct=this.ypos/sr.viewporth*100;return $("#_rad-"+this.id).css({left:pcl+"%",top:pct+"%"})}};return Car}(),SS.events.on("carEvent",function(data){var car;if(sr.running===!1)return!1;car=sr.cars[data.car];return car[data.event]=data.value}),SS.events.on("initCar",function(car){if(sr.running===!1||car===null)return!1;return car.name===sr.user?initMyCar(car):sr.cars[car.name]=initCar(car,!1)}),SS.events.on("initMyCar",function(car){if(sr.running===!1||sr.mycar!==null)return!1;return initMyCar(car)}),SS.events.on("initCars",function(cars){if(sr.running===!1)return!1;return initCars(cars)}),SS.events.on("updateCar",function(car){if(sr.running===!1)return!1;car.msgid>=sr.msgmax?sr.mrecv=0:sr.mrecv=car.msgid;if(car.msgid<sr.mrecv)return!1;if(car.name===sr.user)return!0;if(sr.cars[car.name])return $.each(car,function(k,v){sr.cars[car.name].set(k,v);return!0})}),SS.events.on("signedOut",function(data){if(sr.running===!1)return!1;if(sr.cars[data])return sr.cars[data].destroy()}),SS.events.on("chatMsg",function(data){var car,celem,chat_elem;if(sr.running===!1)return!1;data.name===sr.user?car=sr.mycar:car=sr.cars[data.name],car.cbox===null?(celem=document.createElement("div"),chat_elem=$(celem).addClass("chat"),chat_elem.append("<p>"+data.msg+"</p>"),chat_elem.append('<img src="/images/chatspike.png" class="spike" />'),car.element.append(chat_elem),car.cbox=chat_elem):(clearTimeout(car.ctimeout),car.cbox.find("p").text(data.msg)),car.ctimeout=after(5e3,__bind(function(){return car.cbox.fadeOut(500,__bind(function(){car.cbox.remove(),car.cbox=null;return car.ctimeout=null},this))},this));return!0}),$(window).resize(function(){var canvas;sr.canvas=$("#canvas"),canvas=sr.canvas,canvas.width(window.innerWidth);return canvas.height(window.innerHeight-97)}),after=function(ms,cb){return setTimeout(cb,ms)},every=function(ms,cb){return setInterval(cb,ms)}}).call(this),function(){SS.client.browser||(SS.client.browser={}),SS.client.browser.isSupported=function(){return $.browser.safari===!0||$.browser.webkit===!0||$.browser.mozilla===!0&&parseInt($.browser.version)===2},SS.client.browser.showIncompatibleMessage=function(){$(".views").hide();return $("#browserNotSupported").show()}}.call(this)